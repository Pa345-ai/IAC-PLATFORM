# environments/dev/main.tf
# Development Environment - Cost-Optimized

terraform {
  required_version = ">= 1.6.0"
  
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

locals {
  environment = "dev"
  
  common_tags = {
    Environment = local.environment
    ManagedBy   = "terraform"
    Repository  = "sovereign-cloud-archive"
    CostCenter  = "development"
  }
}

data "terraform_remote_state" "global_networking" {
  backend = "s3"
  
  config = {
    bucket = var.tfstate_bucket
    key    = "global/networking/terraform.tfstate"
    region = var.aws_region
  }
}

data "terraform_remote_state" "global_iam" {
  backend = "s3"
  
  config = {
    bucket = var.tfstate_bucket
    key    = "global/iam/terraform.tfstate"
    region = var.aws_region
  }
}

data "aws_caller_identity" "current" {}

################################################################################
# VPC
################################################################################

module "vpc" {
  source = "../../modules/networking/vpc"
  
  environment             = local.environment
  vpc_cidr                = var.vpc_cidr
  multi_az                = false  # Dev: Single AZ for cost savings
  enable_flow_logs        = true
  enable_vpc_endpoints    = false  # Dev: Use NAT to save costs
  flow_log_retention_days = 30
  kms_key_arn            = module.kms.encryption_key_arn
  
  tags = local.common_tags
}

# Transit Gateway Attachment
resource "aws_ec2_transit_gateway_vpc_attachment" "dev" {
  subnet_ids         = module.vpc.private_subnet_ids
  transit_gateway_id = data.terraform_remote_state.global_networking.outputs.transit_gateway_id
  vpc_id             = module.vpc.vpc_id
  
  transit_gateway_default_route_table_association = false
  transit_gateway_default_route_table_propagation = false
  
  tags = merge(local.common_tags, {
    Name = "${local.environment}-tgw-attachment"
  })
}

resource "aws_ec2_transit_gateway_route_table_association" "dev" {
  transit_gateway_attachment_id  = aws_ec2_transit_gateway_vpc_attachment.dev.id
  transit_gateway_route_table_id = data.terraform_remote_state.global_networking.outputs.non_production_route_table_id
}

################################################################################
# KMS
################################################################################

module "kms" {
  source = "../../modules/security/kms"
  
  environment         = local.environment
  key_name            = "dev-master-key"
  enable_key_rotation = true
  deletion_window     = 7  # Dev: Shorter window
  
  key_administrators = [
    data.terraform_remote_state.global_iam.outputs.admin_role_arn,
    data.terraform_remote_state.global_iam.outputs.developer_role_arn
  ]
  
  key_users = [
    data.terraform_remote_state.global_iam.outputs.eks_cluster_role_arn,
    "arn:aws:iam::${data.aws_caller_identity.current.account_id}:root"
  ]
  
  tags = local.common_tags
}

################################################################################
# EKS - Minimal Configuration
################################################################################

module "eks" {
  source = "../../modules/compute/eks"
  
  environment    = local.environment
  cluster_name   = "${local.environment}-eks-cluster"
  cluster_version = "1.28"
  
  vpc_id     = module.vpc.vpc_id
  subnet_ids = module.vpc.private_subnet_ids
  
  cluster_endpoint_private_access = false
  cluster_endpoint_public_access  = true  # Dev: Public access for developers
  
  cluster_encryption_config = {
    provider_key_arn = module.kms.encryption_key_arn
    resources        = ["secrets"]
  }
  
  cluster_enabled_log_types = ["api"]  # Dev: Minimal logging
  
  # Minimal nodes for dev
  node_groups = {
    application = {
      desired_size   = 1
      min_size       = 1
      max_size       = 3
      instance_types = ["t3.medium"]  # Dev: Smaller instances
      disk_size      = 30
      disk_encrypted = true
      disk_kms_key_id = module.kms.encryption_key_arn
      
      labels = {
        role = "application"
      }
    }
  }
  
  cluster_role_arn           = data.terraform_remote_state.global_iam.outputs.eks_cluster_role_arn
  node_role_arn              = data.terraform_remote_state.global_iam.outputs.eks_node_role_arn
  node_instance_profile_name = data.terraform_remote_state.global_iam.outputs.eks_node_instance_profile
  
  tags = local.common_tags
}

################################################################################
# RDS - Single Instance
################################################################################

module "rds" {
  source = "../../modules/data/rds"
  
  environment = local.environment
  identifier  = "${local.environment}-db"
  
  engine               = "postgres"
  engine_version       = "15.4"
  instance_class       = "db.t3.medium"  # Dev: Smaller instance
  allocated_storage    = 20
  max_allocated_storage = 100
  storage_encrypted    = true
  kms_key_id          = module.kms.encryption_key_arn
  
  multi_az                = false  # Dev: Single AZ
  backup_retention_period = 1      # Dev: Minimal backup
  backup_window           = "03:00-04:00"
  
  vpc_id              = module.vpc.vpc_id
  subnet_ids          = module.vpc.data_subnet_ids
  allowed_cidr_blocks = module.vpc.private_subnet_cidrs
  
  performance_insights_enabled = false  # Dev: Disabled
  monitoring_interval          = 0      # Dev: No enhanced monitoring
  
  tags = local.common_tags
}

output "vpc_id" {
  value = module.vpc.vpc_id
}

output "eks_cluster_endpoint" {
  value     = module.eks.cluster_endpoint
  sensitive = true
}

output "rds_endpoint" {
  value     = module.rds.db_instance_endpoint
  sensitive = true
}