name: Terraform CI/CD Pipeline

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**.tf'
      - '**.tfvars'
      - '.github/workflows/terraform-ci.yml'
  push:
    branches: [main]

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: us-east-1
  
jobs:
  validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [bootstrap, dev, staging, prod]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true
        
      - name: Terraform Init
        working-directory: ./environments/${{ matrix.environment }}
        run: terraform init -backend=false
        
      - name: Terraform Validate
        working-directory: ./environments/${{ matrix.environment }}
        run: terraform validate
        
      - name: TFLint Installation
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash
          
      - name: TFLint Execution
        working-directory: ./environments/${{ matrix.environment }}
        run: |
          tflint --init
          tflint --format compact
          
      - name: Validation Results
        if: steps.fmt.outcome == 'failure'
        run: |
          echo "::error::Terraform formatting check failed. Run 'terraform fmt -recursive' locally."
          exit 1
          
  plan:
    name: Terraform Plan
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    
    strategy:
      matrix:
        environment: [dev, staging]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets[format('AWS_ROLE_{0}', matrix.environment)] }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          
      - name: Terraform Init
        working-directory: ./environments/${{ matrix.environment }}
        run: terraform init
        
      - name: Terraform Plan
        id: plan
        working-directory: ./environments/${{ matrix.environment }}
        run: |
          terraform plan -no-color -out=tfplan.binary
          terraform show -no-color tfplan.binary > tfplan.txt
          
      - name: Save Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ matrix.environment }}
          path: ./environments/${{ matrix.environment }}/tfplan.binary
          retention-days: 5
          
      - name: Comment PR with Plan
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('./environments/${{ matrix.environment }}/tfplan.txt', 'utf8');
            const truncatedPlan = plan.length > 65000 ? plan.substring(0, 65000) + '\n\n... (truncated)' : plan;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Terraform Plan - ${{ matrix.environment }}\n\`\`\`hcl\n${truncatedPlan}\n\`\`\``
            });
            
  apply:
    name: Terraform Apply
    needs: [validate]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      id-token: write
      contents: read
    
    strategy:
      matrix:
        environment: [dev]
      max-parallel: 1
    
    environment:
      name: ${{ matrix.environment }}
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets[format('AWS_ROLE_{0}', matrix.environment)] }}
          aws-region: ${{ env.AWS_REGION }}
          
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          
      - name: Terraform Init
        working-directory: ./environments/${{ matrix.environment }}
        run: terraform init
        
      - name: Terraform Apply
        working-directory: ./environments/${{ matrix.environment }}
        run: terraform apply -auto-approve
        
      - name: Notify Deployment
        if: success()
        run: |
          echo "::notice::Successfully deployed to ${{ matrix.environment }}"