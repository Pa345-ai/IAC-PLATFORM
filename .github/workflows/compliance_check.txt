name: Compliance Policy Enforcement

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  OPA_VERSION: '0.58.0'
  CONFTEST_VERSION: '0.46.0'

jobs:
  opa-policy-check:
    name: OPA Policy Validation
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup OPA
        run: |
          curl -L -o opa https://openpolicyagent.org/downloads/v${{ env.OPA_VERSION }}/opa_linux_amd64_static
          chmod +x opa
          sudo mv opa /usr/local/bin/
          
      - name: Setup Conftest
        run: |
          wget https://github.com/open-policy-agent/conftest/releases/download/v${{ env.CONFTEST_VERSION }}/conftest_${{ env.CONFTEST_VERSION }}_Linux_x86_64.tar.gz
          tar xzf conftest_${{ env.CONFTEST_VERSION }}_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/
          
      - name: Validate Policy Files
        run: |
          for policy in policies/rego/*.rego; do
            echo "Validating $policy"
            opa test $policy
          done
          
      - name: Test Data Residency Policy
        run: |
          conftest test environments/prod/main.tf -p policies/rego/data_residency.rego --all-namespaces
          
      - name: Test Encryption Policy
        run: |
          conftest test environments/ -p policies/rego/encryption_enforcement.rego --all-namespaces
          
      - name: Test IAM Boundary Policy
        run: |
          conftest test environments/global/iam/ -p policies/rego/iam_boundary_check.rego --all-namespaces
          
      - name: Generate Terraform Plan JSON
        if: github.event_name == 'pull_request'
        run: |
          cd environments/dev
          terraform init -backend=false
          terraform plan -out=tfplan.binary
          terraform show -json tfplan.binary > tfplan.json
          
      - name: Review Terraform Plan
        if: github.event_name == 'pull_request'
        run: |
          conftest test environments/dev/tfplan.json -p policies/rego/terraform-plan-review.rego --all-namespaces
          
  sentinel-policy-check:
    name: Sentinel Policy Enforcement
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Validate Sentinel Policies
        run: |
          if [ -f "policies/sentinel.hcl" ]; then
            echo "âœ“ Sentinel configuration found"
            grep -q "policy" policies/sentinel.hcl && echo "âœ“ Policies defined" || echo "::warning::No policies found"
          fi
          
  cost-estimation:
    name: Infrastructure Cost Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup Infracost
        uses: infracost/actions/setup@v3
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
          
      - name: Generate Cost Estimate
        run: |
          infracost breakdown --path=environments/prod \
            --format=json \
            --out-file=infracost.json
            
      - name: Post Cost Comment
        run: |
          infracost comment github --path=infracost.json \
            --repo=${{ github.repository }} \
            --github-token=${{ secrets.GITHUB_TOKEN }} \
            --pull-request=${{ github.event.pull_request.number }} \
            --behavior=update
            
  drift-detection:
    name: Infrastructure Drift Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'push'
    permissions:
      id-token: write
      contents: read
      issues: write
      
    strategy:
      matrix:
        environment: [prod, staging]
        
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets[format('AWS_ROLE_{0}', matrix.environment)] }}
          aws-region: us-east-1
          
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
          
      - name: Detect Drift
        id: drift
        working-directory: ./environments/${{ matrix.environment }}
        run: |
          terraform init
          terraform plan -detailed-exitcode -no-color || echo "drift_detected=true" >> $GITHUB_OUTPUT
          
      - name: Create Drift Issue
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Infrastructure Drift Detected - ${{ matrix.environment }}`,
              body: `Infrastructure drift has been detected in the **${{ matrix.environment }}** environment.\n\nPlease review and remediate immediately.\n\n**Environment:** ${{ matrix.environment }}\n**Detection Time:** ${new Date().toISOString()}`,
              labels: ['infrastructure', 'drift', 'priority-high']
            });
            
  compliance-report:
    name: Generate Compliance Report
    needs: [opa-policy-check, sentinel-policy-check]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Compliance Summary
        run: |
          echo "## ðŸ“‹ Compliance Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Policy Engine | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| OPA/Rego | ${{ needs.opa-policy-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sentinel | ${{ needs.sentinel-policy-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Compliance Standards" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ PCI-DSS v4.0" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ NIST 800-53" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ SOC 2 Type II" >> $GITHUB_STEP_SUMMARY
          echo "- âœ“ GDPR Article 32" >> $GITHUB_STEP_SUMMARY